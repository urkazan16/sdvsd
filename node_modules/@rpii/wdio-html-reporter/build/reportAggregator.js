"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _htmlGenerator = _interopRequireDefault(require("./htmlGenerator"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const fs = require('fs-extra');

const path = require('path');

const moment = require('moment');

function walk(dir, extensions, filelist = []) {
  const files = fs.readdirSync(dir);
  files.forEach(function (file) {
    const filepath = path.join(dir, file);
    const stat = fs.statSync(filepath);

    if (stat.isDirectory()) {
      filelist = walk(filepath, extensions, filelist);
    } else {
      extensions.forEach(function (extension) {
        if (file.indexOf(extension) == file.length - extension.length) {
          filelist.push(filepath);
        }
      });
    }
  });
  return filelist;
}

class ReportAggregator {
  constructor(opts) {
    opts = Object.assign({}, {
      outputDir: 'reports/html-reports/',
      filename: 'master-report.html',
      reportTitle: 'Test Master Report'
    }, opts);
    this.options = opts;
    this.options.reportFile = path.join(process.cwd(), this.options.outputDir, this.options.filename);
    this.reports = [];
  }

  clean() {
    fs.emptyDirSync(this.options.outputDir);
  }

  readJsonFiles() {
    return walk(this.options.outputDir, [".json"]);
  }

  async createReport(results) {
    let metrics = {
      passed: 0,
      skipped: 0,
      failed: 0,
      start: moment("2048-01-01T01:00:00-08:00"),
      end: moment("2000-01-01T01:00:00-08:00"),
      duration: 0
    };
    let suites = [];
    let specs = [];
    let files = this.readJsonFiles();

    for (let i = 0; i < files.length; i++) {
      try {
        let filename = files[i];
        let report = JSON.parse(fs.readFileSync(filename));
        report.info.specs.forEach(spec => {
          specs.push(spec);
        });
        this.reports.push(report);
        metrics.passed += report.metrics.passed;
        metrics.failed += report.metrics.failed;
        metrics.skipped += report.metrics.skipped;

        for (let k = 0; k < report.suites.length; k++) {
          let suite = report.suites[k];
          let start = moment.utc(suite.start);

          if (start.isSameOrBefore(metrics.start)) {
            metrics.start = start;
          }

          let end = moment.utc(suite.end);

          if (end.isAfter(metrics.end)) {
            metrics.end = end;
          }

          suites.push(suite);
        }
      } catch (ex) {
        console.error(ex);
      }
    }

    metrics.duration = moment.duration(metrics.end.diff(metrics.start), "milliseconds").format('hh:mm:ss.SS', {
      trim: false
    });
    metrics.start = metrics.start.format();
    metrics.end = metrics.end.format();
    const reportOptions = {
      data: {
        info: this.reports[0].info,
        specs: specs,
        metrics: metrics,
        suites: suites,
        title: this.options.reportTitle
      },
      outputDir: this.options.outputDir,
      reportFile: this.options.reportFile,
      openInBrowser: true
    };

    _htmlGenerator.default.htmlOutput(reportOptions);
  }

}

var _default = ReportAggregator;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9yZXBvcnRBZ2dyZWdhdG9yLmpzIl0sIm5hbWVzIjpbImZzIiwicmVxdWlyZSIsInBhdGgiLCJtb21lbnQiLCJ3YWxrIiwiZGlyIiwiZXh0ZW5zaW9ucyIsImZpbGVsaXN0IiwiZmlsZXMiLCJyZWFkZGlyU3luYyIsImZvckVhY2giLCJmaWxlIiwiZmlsZXBhdGgiLCJqb2luIiwic3RhdCIsInN0YXRTeW5jIiwiaXNEaXJlY3RvcnkiLCJleHRlbnNpb24iLCJpbmRleE9mIiwibGVuZ3RoIiwicHVzaCIsIlJlcG9ydEFnZ3JlZ2F0b3IiLCJjb25zdHJ1Y3RvciIsIm9wdHMiLCJPYmplY3QiLCJhc3NpZ24iLCJvdXRwdXREaXIiLCJmaWxlbmFtZSIsInJlcG9ydFRpdGxlIiwib3B0aW9ucyIsInJlcG9ydEZpbGUiLCJwcm9jZXNzIiwiY3dkIiwicmVwb3J0cyIsImNsZWFuIiwiZW1wdHlEaXJTeW5jIiwicmVhZEpzb25GaWxlcyIsImNyZWF0ZVJlcG9ydCIsInJlc3VsdHMiLCJtZXRyaWNzIiwicGFzc2VkIiwic2tpcHBlZCIsImZhaWxlZCIsInN0YXJ0IiwiZW5kIiwiZHVyYXRpb24iLCJzdWl0ZXMiLCJzcGVjcyIsImkiLCJyZXBvcnQiLCJKU09OIiwicGFyc2UiLCJyZWFkRmlsZVN5bmMiLCJpbmZvIiwic3BlYyIsImsiLCJzdWl0ZSIsInV0YyIsImlzU2FtZU9yQmVmb3JlIiwiaXNBZnRlciIsImV4IiwiY29uc29sZSIsImVycm9yIiwiZGlmZiIsImZvcm1hdCIsInRyaW0iLCJyZXBvcnRPcHRpb25zIiwiZGF0YSIsInRpdGxlIiwib3BlbkluQnJvd3NlciIsIkh0bWxHZW5lcmF0b3IiLCJodG1sT3V0cHV0Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQTs7OztBQUVBLE1BQU1BLEVBQUUsR0FBR0MsT0FBTyxDQUFDLFVBQUQsQ0FBbEI7O0FBQ0EsTUFBTUMsSUFBSSxHQUFHRCxPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFDQSxNQUFNRSxN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LFVBQWQsQ0FBeUJMLGFBQXpCO0FBRUg7O0FBekZrQjs7ZUE0Rko3QyxnQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBIdG1sR2VuZXJhdG9yIGZyb20gXCIuL2h0bWxHZW5lcmF0b3JcIjtcclxuXHJcbmNvbnN0IGZzID0gcmVxdWlyZSgnZnMtZXh0cmEnKTtcclxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcclxuY29uc3QgbW9tZW50ID0gcmVxdWlyZSgnbW9tZW50Jyk7XHJcblxyXG5mdW5jdGlvbiAgd2FsayhkaXIsIGV4dGVuc2lvbnMgLCBmaWxlbGlzdCA9IFtdKSB7XHJcbiAgICBjb25zdCBmaWxlcyA9IGZzLnJlYWRkaXJTeW5jKGRpcik7XHJcblxyXG4gICAgZmlsZXMuZm9yRWFjaChmdW5jdGlvbiAoZmlsZSkge1xyXG4gICAgICAgIGNvbnN0IGZpbGVwYXRoID0gcGF0aC5qb2luKGRpciwgZmlsZSk7XHJcbiAgICAgICAgY29uc3Qgc3RhdCA9IGZzLnN0YXRTeW5jKGZpbGVwYXRoKTtcclxuXHJcbiAgICAgICAgaWYgKHN0YXQuaXNEaXJlY3RvcnkoKSkge1xyXG4gICAgICAgICAgICBmaWxlbGlzdCA9IHdhbGsoZmlsZXBhdGgsIGV4dGVuc2lvbnMsIGZpbGVsaXN0KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBleHRlbnNpb25zLmZvckVhY2goZnVuY3Rpb24gKGV4dGVuc2lvbikge1xyXG4gICAgICAgICAgICAgICAgaWYgKGZpbGUuaW5kZXhPZihleHRlbnNpb24pID09IGZpbGUubGVuZ3RoIC0gZXh0ZW5zaW9uLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGZpbGVsaXN0LnB1c2goZmlsZXBhdGgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICByZXR1cm4gZmlsZWxpc3Q7XHJcbn1cclxuXHJcbmNsYXNzIFJlcG9ydEFnZ3JlZ2F0b3Ige1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKG9wdHMpIHtcclxuICAgICAgICBvcHRzID0gT2JqZWN0LmFzc2lnbih7fSwge1xyXG4gICAgICAgICAgICBvdXRwdXREaXI6ICdyZXBvcnRzL2h0bWwtcmVwb3J0cy8nLFxyXG4gICAgICAgICAgICBmaWxlbmFtZTogJ21hc3Rlci1yZXBvcnQuaHRtbCcsXHJcbiAgICAgICAgICAgIHJlcG9ydFRpdGxlOiAnVGVzdCBNYXN0ZXIgUmVwb3J0JyxcclxuICAgICAgICB9LCBvcHRzKTtcclxuICAgICAgICB0aGlzLm9wdGlvbnMgPSBvcHRzO1xyXG4gICAgICAgIHRoaXMub3B0aW9ucy5yZXBvcnRGaWxlID0gcGF0aC5qb2luKHByb2Nlc3MuY3dkKCksIHRoaXMub3B0aW9ucy5vdXRwdXREaXIsIHRoaXMub3B0aW9ucy5maWxlbmFtZSk7XHJcbiAgICAgICAgdGhpcy5yZXBvcnRzID0gW107XHJcbiAgICB9XHJcblxyXG4gICAgY2xlYW4oKSB7XHJcbiAgICAgICAgZnMuZW1wdHlEaXJTeW5jKHRoaXMub3B0aW9ucy5vdXRwdXREaXIpO1xyXG4gICAgfVxyXG5cclxuXHJcblxyXG4gICAgcmVhZEpzb25GaWxlcygpIHtcclxuICAgICAgICByZXR1cm4gd2Fsayh0aGlzLm9wdGlvbnMub3V0cHV0RGlyLCBbXCIuanNvblwiXSk7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIGFzeW5jIGNyZWF0ZVJlcG9ydChyZXN1bHRzKSB7XHJcblxyXG4gICAgICAgIGxldCBtZXRyaWNzID0ge1xyXG4gICAgICAgICAgICBwYXNzZWQ6IDAsXHJcbiAgICAgICAgICAgIHNraXBwZWQ6IDAsXHJcbiAgICAgICAgICAgIGZhaWxlZDogMCxcclxuICAgICAgICAgICAgc3RhcnQgOiBtb21lbnQoXCIyMDQ4LTAxLTAxVDAxOjAwOjAwLTA4OjAwXCIpLFxyXG4gICAgICAgICAgICBlbmQgOiBtb21lbnQoXCIyMDAwLTAxLTAxVDAxOjAwOjAwLTA4OjAwXCIpLFxyXG4gICAgICAgICAgICBkdXJhdGlvbjogMFxyXG4gICAgICAgIH07XHJcbiAgICAgICAgbGV0IHN1aXRlcyA9IFtdO1xyXG4gICAgICAgIGxldCBzcGVjcyA9IFtdO1xyXG5cclxuICAgICAgICBsZXQgZmlsZXMgPSB0aGlzLnJlYWRKc29uRmlsZXMoKTtcclxuXHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBmaWxlcy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgbGV0IGZpbGVuYW1lID0gZmlsZXNbaV07XHJcbiAgICAgICAgICAgICAgICBsZXQgcmVwb3J0ID0gSlNPTi5wYXJzZShmcy5yZWFkRmlsZVN5bmMoZmlsZW5hbWUpKTtcclxuICAgICAgICAgICAgICAgIHJlcG9ydC5pbmZvLnNwZWNzLmZvckVhY2goKHNwZWMpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBzcGVjcy5wdXNoKHNwZWMpIDtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuXHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlcG9ydHMucHVzaChyZXBvcnQpO1xyXG4gICAgICAgICAgICAgICAgbWV0cmljcy5wYXNzZWQgKz0gcmVwb3J0Lm1ldHJpY3MucGFzc2VkO1xyXG4gICAgICAgICAgICAgICAgbWV0cmljcy5mYWlsZWQgKz0gcmVwb3J0Lm1ldHJpY3MuZmFpbGVkO1xyXG4gICAgICAgICAgICAgICAgbWV0cmljcy5za2lwcGVkICs9IHJlcG9ydC5tZXRyaWNzLnNraXBwZWQ7XHJcblxyXG4gICAgICAgICAgICAgICAgZm9yIChsZXQgayA9IDA7IGsgPCByZXBvcnQuc3VpdGVzLmxlbmd0aDsgaysrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IHN1aXRlID0gcmVwb3J0LnN1aXRlc1trXSA7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IHN0YXJ0ID0gbW9tZW50LnV0YyhzdWl0ZS5zdGFydCkgO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICggc3RhcnQuaXNTYW1lT3JCZWZvcmUobWV0cmljcy5zdGFydCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWV0cmljcy5zdGFydCA9ICBzdGFydCA7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGxldCBlbmQgPSBtb21lbnQudXRjKHN1aXRlLmVuZCkgO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICggZW5kLmlzQWZ0ZXIobWV0cmljcy5lbmQpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1ldHJpY3MuZW5kID0gIGVuZCA7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIHN1aXRlcy5wdXNoKHN1aXRlKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBjYXRjaCAoZXgpIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXgpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgIH1cclxuICAgICAgICBtZXRyaWNzLmR1cmF0aW9uID0gbW9tZW50LmR1cmF0aW9uKG1ldHJpY3MuZW5kLmRpZmYobWV0cmljcy5zdGFydCksIFwibWlsbGlzZWNvbmRzXCIpLmZvcm1hdCgnaGg6bW06c3MuU1MnLCB7dHJpbTogZmFsc2V9KTtcclxuICAgICAgICBtZXRyaWNzLnN0YXJ0ID0gbWV0cmljcy5zdGFydC5mb3JtYXQoKSA7XHJcbiAgICAgICAgbWV0cmljcy5lbmQgPSBtZXRyaWNzLmVuZC5mb3JtYXQoKSA7XHJcblxyXG4gICAgICAgIGNvbnN0IHJlcG9ydE9wdGlvbnMgPSB7XHJcbiAgICAgICAgICAgIGRhdGE6IHtcclxuICAgICAgICAgICAgICAgIGluZm86IHRoaXMucmVwb3J0c1swXS5pbmZvLFxyXG4gICAgICAgICAgICAgICAgc3BlY3M6c3BlY3MsXHJcbiAgICAgICAgICAgICAgICBtZXRyaWNzOiBtZXRyaWNzLFxyXG4gICAgICAgICAgICAgICAgc3VpdGVzOiBzdWl0ZXMsXHJcbiAgICAgICAgICAgICAgICB0aXRsZTogdGhpcy5vcHRpb25zLnJlcG9ydFRpdGxlLFxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBvdXRwdXREaXI6IHRoaXMub3B0aW9ucy5vdXRwdXREaXIsXHJcbiAgICAgICAgICAgIHJlcG9ydEZpbGU6IHRoaXMub3B0aW9ucy5yZXBvcnRGaWxlLFxyXG4gICAgICAgICAgICBvcGVuSW5Ccm93c2VyOiB0cnVlXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgSHRtbEdlbmVyYXRvci5odG1sT3V0cHV0KHJlcG9ydE9wdGlvbnMpO1xyXG5cclxuICAgIH1cclxufVxyXG5cclxuICAgIGV4cG9ydCBkZWZhdWx0IFJlcG9ydEFnZ3JlZ2F0b3I7XHJcbiJdfQ==