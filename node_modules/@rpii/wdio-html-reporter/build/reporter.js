"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _reporter = _interopRequireDefault(require("@wdio/reporter"));

var _htmlGenerator = _interopRequireDefault(require("./htmlGenerator"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const fs = require('fs-extra');

const _ = require('lodash');

const path = require('path');

const moment = require('moment');

const momentDurationFormatSetup = require("moment-duration-format");

momentDurationFormatSetup(moment);

class HtmlReporter extends _reporter.default {
  constructor(opts) {
    opts = Object.assign({}, {
      stdout: true,
      outputDir: 'reports/html-reports/',
      filename: 'report.html',
      reportTitle: 'Test Report Title',
      showInBrowser: false,
      useOnAfterCommandForScreenshot: true
    }, opts);
    super(opts);
    this.options = opts;
    const dir = this.options.outputDir + 'screenshots';
    fs.ensureDirSync(dir);
    this.suiteUids = [];
    this.suites = [];
    this.indents = 0;
    this.suiteIndents = {};
    this.metrics = {
      passed: 0,
      skipped: 0,
      failed: 0,
      start: 0,
      end: 0,
      duration: 0
    };
    this.openInProgress = false;
    this.defaultTestIndent = '   ';
    process.on('test:log', this.saveMessage.bind(this));
    process.on('test:screenshot', this.saveScreenshot.bind(this));
  }

  get isSynchronised() {
    return !this.openInProgress;
  }

  onRunnerStart(runner) {
    this.log("onRunnerStart: ", JSON.stringify(runner)); //todo look at fix, not async safe. but one cid per report file

    this.cid = runner.cid;
    this.runner = runner;
    this.metrics.passed = 0;
    this.metrics.skipped = 0;
    this.metrics.failed = 0;
  }

  onSuiteStart(suite) {
    this.suiteUids.push(suite.uid);
    this.suiteIndents[suite.uid] = ++this.indents;
    this.suiteUid = suite.uid;
    this.suites.push(suite);
    this.log("onSuiteStart: ", JSON.stringify(suite));
  }

  onTestStart(theTest) {
    this.log("onTestStart: ", JSON.stringify(theTest));
    this.testUid = theTest.uid;
    let test = this.getTest(theTest.uid);
    test.events = [];
    test.errorIndex = 0;
  }

  onTestPass(test) {
    this.log("onTestPass: ", JSON.stringify(test));
    this.metrics.passed++;
  }

  onTestSkip(test) {
    this.log("onTestSkip: ", JSON.stringify(test));
    this.metrics.skipped++;
  }

  onTestFail(test) {
    this.log("onTestFail: ", JSON.stringify(test));
    this.metrics.failed++;
  }

  onHookEnd(hook) {
    if (hook.error) {
      this.metrics.failed++;
    }
  }

  onTestEnd(theTest) {
    this.log("onTestEnd: ", JSON.stringify(theTest));
    let test = this.getTest(theTest.uid);
    this.moveErrorsToEvents(test);
  }

  onSuiteEnd(suite) {
    this.log("onSuiteEnd: ", JSON.stringify(suite));
    this.indents--;
  }

  isScreenshotCommand(command) {
    const isScreenshotEndpoint = /\/session\/[^/]*\/screenshot/;
    return isScreenshotEndpoint.test(command.endpoint);
  } //this is a hack to get around lack of onScreenshot event


  onAfterCommand(command) {
    if (this.options.useOnAfterCommandForScreenshot) {
      if (this.isScreenshotCommand(command) && command.result.value) {
        const timestamp = moment().format('YYYYMMDD-HHmmss.SSS');
        const filepath = path.join(this.options.outputDir, '/screenshots/', this.cid, timestamp, this.options.filename + '.png');
        fs.outputFileSync(filepath, Buffer.from(command.result.value, 'base64'));
        let test = this.getTest(this.testUid);
        test.events.push({
          type: 'screenshot',
          value: filepath
        });
      }
    }
  }

  log(message, object, force) {
    if (this.options.debug || force) {
      console.log(message + object);
    }
  }

  getSuite(uid) {
    for (let i = 0; i < this.suites.length; i++) {
      if (uid === this.suites[i].uid) {
        return this.suites[i];
      }
    }

    return null;
  }

  getTest(uid) {
    let suite = this.getSuite(this.suiteUid);

    for (let i = 0; i < suite.tests.length; i++) {
      if (uid === suite.tests[i].uid) {
        return suite.tests[i];
      }
    }

    return null;
  } //this is a hack.  we have to move all the things in test.errors before they get blown away


  moveErrorsToEvents(test) {
    if (test.errors) {
      for (let i = test.errorIndex; i < test.errors.length; i++) {
        test.events.push(test.errors[i]);
      }

      test.errorIndex = test.errors.length;
    }
  }

  saveScreenshot(filepath) {
    let test = this.getTest(this.testUid);
    this.moveErrorsToEvents(test);
    test.events.push({
      type: 'screenshot',
      value: filepath
    });
  }

  saveMessage(message) {
    const test = this.getTest(this.testUid);
    this.moveErrorsToEvents(test);
    test.events.push({
      type: 'log',
      value: message
    });
  }

  getOrderedSuites() {
    if (this.orderedSuites) {
      return this.orderedSuites;
    }

    this.orderedSuites = [];

    for (const uid of this.suiteUids) {
      for (const suite of this.suites) {
        if (suite.uid !== uid) {
          continue;
        }

        this.orderedSuites.push(suite);
      }
    }

    return this.orderedSuites;
  } // convert to a style class


  indent(uid) {
    const indents = this.suiteIndents[uid];
    return indents === 0 ? '' : Array(indents).join('    ');
  }

  onRunnerEnd(runner) {
    let self = this;
    this.log("onRunnerEnd: ", JSON.stringify(runner));
    self.openInProgress = true;
    self.metrics.start = runner.start;
    self.metrics.end = runner.end;
    self.metrics.duration = runner._duration;
    const reportOptions = {
      data: {
        info: runner,
        metrics: self.metrics,
        suites: self.getOrderedSuites(),
        title: self.options.reportTitle
      },
      showInBrowser: self.options.showInBrowser,
      outputDir: self.options.outputDir,
      reportFile: path.join(process.cwd(), self.options.outputDir, self.suiteUid, self.cid, self.options.filename)
    };

    _htmlGenerator.default.htmlOutput(reportOptions, () => {
      self.openInProgress = false;
    });
  }

}

var _default = HtmlReporter;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9yZXBvcnRlci5qcyJdLCJuYW1lcyI6WyJmcyIsInJlcXVpcmUiLCJfIiwicGF0aCIsIm1vbWVudCIsIm1vbWVudER1cmF0aW9uRm9ybWF0U2V0dXAiLCJIdG1sUmVwb3J0ZXIiLCJXRElPUmVwb3J0ZXIiLCJjb25zdHJ1Y3RvciIsIm9wdHMiLCJPYmplY3QiLCJhc3NpZ24iLCJzdGRvdXQiLCJvdXRwdXREaXIiLCJmaWxlbmFtZSIsInJlcG9ydFRpdGxlIiwic2hvd0luQnJvd3NlciIsInVzZU9uQWZ0ZXJDb21tYW5kRm9yU2NyZWVuc2hvdCIsIm9wdGlvbnMiLCJkaXIiLCJlbnN1cmVEaXJTeW5jIiwic3VpdGVVaWRzIiwic3VpdGVzIiwiaW5kZW50cyIsInN1aXRlSW5kZW50cyIsIm1ldHJpY3MiLCJwYXNzZWQiLCJza2lwcGVkIiwiZmFpbGVkIiwic3RhcnQiLCJlbmQiLCJkdXJhdGlvbiIsIm9wZW5JblByb2dyZXNzIiwiZGVmYXVsdFRlc3RJbmRlbnQiLCJwcm9jZXNzIiwib24iLCJzYXZlTWVzc2FnZSIsImJpbmQiLCJzYXZlU2NyZWVuc2hvdCIsImlzU3luY2hyb25pc2VkIiwib25SdW5uZXJTdGFydCIsInJ1bm5lciIsImxvZyIsIkpTT04iLCJzdHJpbmdpZnkiLCJjaWQiLCJvblN1aXRlU3RhcnQiLCJzdWl0ZSIsInB1c2giLCJ1aWQiLCJzdWl0ZVVpZCIsIm9uVGVzdFN0YXJ0IiwidGhlVGVzdCIsInRlc3RVaWQiLCJ0ZXN0IiwiZ2V0VGVzdCIsImV2ZW50cyIsImVycm9ySW5kZXgiLCJvblRlc3RQYXNzIiwib25UZXN0U2tpcCIsIm9uVGVzdEZhaWwiLCJvbkhvb2tFbmQiLCJob29rIiwiZXJyb3IiLCJvblRlc3RFbmQiLCJtb3ZlRXJyb3JzVG9FdmVudHMiLCJvblN1aXRlRW5kIiwiaXNTY3JlZW5zaG90Q29tbWFuZCIsImNvbW1hbmQiLCJpc1NjcmVlbnNob3RFbmRwb2ludCIsImVuZHBvaW50Iiwib25BZnRlckNvbW1hbmQiLCJyZXN1bHQiLCJ2YWx1ZSIsInRpbWVzdGFtcCIsImZvcm1hdCIsImZpbGVwYXRoIiwiam9pbiIsIm91dHB1dEZpbGVTeW5jIiwiQnVmZmVyIiwiZnJvbSIsInR5cGUiLCJtZXNzYWdlIiwib2JqZWN0IiwiZm9yY2UiLCJkZWJ1ZyIsImNvbnNvbGUiLCJnZXRTdWl0ZSIsImkiLCJsZW5ndGgiLCJ0ZXN0cyIsImVycm9ycyIsImdldE9yZGVyZWRTdWl0ZXMiLCJvcmRlcmVkU3VpdGVzIiwiaW5kZW50IiwiQXJyYXkiLCJvblJ1bm5lckVuZCIsInNlbGYiLCJfZHVyYXRpb24iLCJyZXBvcnRPcHRpb25zIiwiZGF0YSIsImluZm8iLCJ0aXRsZSIsInJlcG9ydEZpbGUiLCJjd2QiLCJIdG1sR2VuZXJhdG9yIiwiaHRtbE91dHB1dCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUE7O0FBQ0E7Ozs7QUFFQSxNQUFNQSxFQUFFLEdBQUdDLE9BQU8sQ0FBQyxVQUFELENBQWxCOztBQUNBLE1BQU1DLENBQUMsR0FBR0QsT0FBTyxDQUFDLFFBQUQsQ0FBakI7O0FBQ0EsTUFBTUUsSUFBSSxHQUFHRixPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFDQSxNQUFNRyxNQUFNLEdBQUdILE9BQU8sQ0FBQyxRQUFELENBQXRCOztBQUNBLE1BQU1JLHlCQUF5QixHQUFHSixPQUFPLENBQUMsd0JBQUQsQ0FBekM7O0FBQ0FJLHlCQUF5QixDQUFDRCxNQUFELENBQXpCOztBQUdBLE1BQU1FLFlBQU4sU0FBMkJDLGlCQUEzQixDQUF3QztBQUVwQ0MsRUFBQUEsV0FBVyxDQUFDQyxJQUFELEVBQU87QUFDZEEsSUFBQUEsSUFBSSxHQUFHQyxNQUFNLENBQUNDLE1BQVAsQ0FBYyxFQUFkLEVBQWtCO0FBQ3JCQyxNQUFBQSxNQUFNLEVBQUUsSUFEYTtBQUVyQkMsTUFBQUEsU0FBUyxFQUFFLHVCQUZVO0FBR3JCQyxNQUFBQSxRQUFRLEVBQUUsYUFIVztBQUlyQkMsTUFBQUEsV0FBVyxFQUFFLG1CQUpRO0FBS3JCQyxNQUFBQSxhQUFh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QUwsQ0FBYUwsU0FBdEMsRUFBaURvRixJQUFJLENBQUMvQyxRQUF0RCxFQUFpRStDLElBQUksQ0FBQ3BELEdBQXRFLEVBQTJFb0QsSUFBSSxDQUFDL0UsT0FBTCxDQUFhSixRQUF4RjtBQVRLLEtBQXRCOztBQVdBMkYsMkJBQWNDLFVBQWQsQ0FBeUJQLGFBQXpCLEVBQXVDLE1BQU07QUFDekNGLE1BQUFBLElBQUksQ0FBQ2pFLGNBQUwsR0FBc0IsS0FBdEI7QUFDSCxLQUZEO0FBR0g7O0FBcE5tQzs7ZUF3TnpCMUIsWSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBXRElPUmVwb3J0ZXIgZnJvbSAnQHdkaW8vcmVwb3J0ZXInXHJcbmltcG9ydCBIdG1sR2VuZXJhdG9yIGZyb20gJy4vaHRtbEdlbmVyYXRvcidcclxuXHJcbmNvbnN0IGZzID0gcmVxdWlyZSgnZnMtZXh0cmEnKTtcclxuY29uc3QgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpO1xyXG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xyXG5jb25zdCBtb21lbnQgPSByZXF1aXJlKCdtb21lbnQnKTtcclxuY29uc3QgbW9tZW50RHVyYXRpb25Gb3JtYXRTZXR1cCA9IHJlcXVpcmUoXCJtb21lbnQtZHVyYXRpb24tZm9ybWF0XCIpO1xyXG5tb21lbnREdXJhdGlvbkZvcm1hdFNldHVwKG1vbWVudCk7XHJcblxyXG5cclxuY2xhc3MgSHRtbFJlcG9ydGVyIGV4dGVuZHMgV0RJT1JlcG9ydGVyIHtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihvcHRzKSB7XHJcbiAgICAgICAgb3B0cyA9IE9iamVjdC5hc3NpZ24oe30sIHtcclxuICAgICAgICAgICAgc3Rkb3V0OiB0cnVlLFxyXG4gICAgICAgICAgICBvdXRwdXREaXI6ICdyZXBvcnRzL2h0bWwtcmVwb3J0cy8nLFxyXG4gICAgICAgICAgICBmaWxlbmFtZTogJ3JlcG9ydC5odG1sJyxcclxuICAgICAgICAgICAgcmVwb3J0VGl0bGU6ICdUZXN0IFJlcG9ydCBUaXRsZScsXHJcbiAgICAgICAgICAgIHNob3dJbkJyb3dzZXI6IGZhbHNlLFxyXG4gICAgICAgICAgICB1c2VPbkFmdGVyQ29tbWFuZEZvclNjcmVlbnNob3Q6IHRydWUsXHJcbiAgICAgICAgfSwgb3B0cyk7XHJcbiAgICAgICAgc3VwZXIob3B0cyk7XHJcbiAgICAgICAgdGhpcy5vcHRpb25zID0gb3B0cztcclxuICAgICAgICBjb25zdCBkaXIgPSB0aGlzLm9wdGlvbnMub3V0cHV0RGlyICsgJ3NjcmVlbnNob3RzJyA7XHJcblxyXG4gICAgICAgIGZzLmVuc3VyZURpclN5bmMoZGlyKSA7XHJcbiAgICAgICAgdGhpcy5zdWl0ZVVpZHMgPSBbXTtcclxuICAgICAgICB0aGlzLnN1aXRlcyA9IFtdO1xyXG4gICAgICAgIHRoaXMuaW5kZW50cyA9IDA7XHJcbiAgICAgICAgdGhpcy5zdWl0ZUluZGVudHMgPSB7fTtcclxuICAgICAgICB0aGlzLm1ldHJpY3MgPSB7XHJcbiAgICAgICAgICAgIHBhc3NlZCA6IDAsXHJcbiAgICAgICAgICAgIHNraXBwZWQgOiAwLFxyXG4gICAgICAgICAgICBmYWlsZWQgOiAwLFxyXG4gICAgICAgICAgICBzdGFydDogMCxcclxuICAgICAgICAgICAgZW5kOiAwICxcclxuICAgICAgICAgICAgZHVyYXRpb246MFxyXG4gICAgICAgIH07XHJcbiAgICAgICAgdGhpcy5vcGVuSW5Qcm9ncmVzcyA9IGZhbHNlO1xyXG4gICAgICAgIHRoaXMuZGVmYXVsdFRlc3RJbmRlbnQgPSAnICAgJyA7XHJcbiAgICAgICAgcHJvY2Vzcy5vbigndGVzdDpsb2cnLCB0aGlzLnNhdmVNZXNzYWdlLmJpbmQodGhpcykpO1xyXG4gICAgICAgIHByb2Nlc3Mub24oJ3Rlc3Q6c2NyZWVuc2hvdCcsIHRoaXMuc2F2ZVNjcmVlbnNob3QuYmluZCh0aGlzKSk7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIGdldCBpc1N5bmNocm9uaXNlZCAoKSB7XHJcbiAgICAgICAgcmV0dXJuICF0aGlzLm9wZW5JblByb2dyZXNzIDtcclxuICAgIH1cclxuXHJcbiAgICBvblJ1bm5lclN0YXJ0KHJ1bm5lcikge1xyXG4gICAgICAgIHRoaXMubG9nKFwib25SdW5uZXJTdGFydDogXCIgLCBKU09OLnN0cmluZ2lmeShydW5uZXIpKTtcclxuICAgICAgICAvL3RvZG8gbG9vayBhdCBmaXgsIG5vdCBhc3luYyBzYWZlLiBidXQgb25lIGNpZCBwZXIgcmVwb3J0IGZpbGVcclxuICAgICAgICB0aGlzLmNpZCA9IHJ1bm5lci5jaWQ7XHJcbiAgICAgICAgdGhpcy5ydW5uZXIgPSBydW5uZXI7XHJcbiAgICAgICAgdGhpcy5tZXRyaWNzLnBhc3NlZCA9IDA7XHJcbiAgICAgICAgdGhpcy5tZXRyaWNzLnNraXBwZWQgPSAwO1xyXG4gICAgICAgIHRoaXMubWV0cmljcy5mYWlsZWQgPSAwO1xyXG4gICAgfVxyXG5cclxuICAgIG9uU3VpdGVTdGFydChzdWl0ZSkge1xyXG4gICAgICAgIHRoaXMuc3VpdGVVaWRzLnB1c2goc3VpdGUudWlkKTtcclxuICAgICAgICB0aGlzLnN1aXRlSW5kZW50c1tzdWl0ZS51aWRdID0gKyt0aGlzLmluZGVudHM7XHJcbiAgICAgICAgdGhpcy5zdWl0ZVVpZCA9IHN1aXRlLnVpZDtcclxuICAgICAgICB0aGlzLnN1aXRlcy5wdXNoKHN1aXRlKTtcclxuICAgICAgICB0aGlzLmxvZyhcIm9uU3VpdGVTdGFydDogXCIgLCBKU09OLnN0cmluZ2lmeShzdWl0ZSkpO1xyXG4gICAgfVxyXG5cclxuICAgIG9uVGVzdFN0YXJ0KHRoZVRlc3QpIHtcclxuICAgICAgICB0aGlzLmxvZyhcIm9uVGVzdFN0YXJ0OiBcIiAsIEpTT04uc3RyaW5naWZ5KHRoZVRlc3QpKTtcclxuICAgICAgICB0aGlzLnRlc3RVaWQgPSB0aGVUZXN0LnVpZCA7XHJcbiAgICAgICAgbGV0IHRlc3QgPSB0aGlzLmdldFRlc3QodGhlVGVzdC51aWQpIDtcclxuICAgICAgICB0ZXN0LmV2ZW50cyA9IFtdO1xyXG4gICAgICAgIHRlc3QuZXJyb3JJbmRleCA9IDAgO1xyXG4gICAgfVxyXG5cclxuICAgIG9uVGVzdFBhc3ModGVzdCkge1xyXG4gICAgICAgIHRoaXMubG9nKFwib25UZXN0UGFzczogXCIgLCBKU09OLnN0cmluZ2lmeSh0ZXN0KSk7XHJcbiAgICAgICAgdGhpcy5tZXRyaWNzLnBhc3NlZCsrO1xyXG4gICAgfVxyXG5cclxuICAgIG9uVGVzdFNraXAodGVzdCkge1xyXG4gICAgICAgIHRoaXMubG9nKFwib25UZXN0U2tpcDogXCIgLCBKU09OLnN0cmluZ2lmeSh0ZXN0KSk7XHJcbiAgICAgICAgdGhpcy5tZXRyaWNzLnNraXBwZWQrKztcclxuICAgIH1cclxuXHJcbiAgICBvblRlc3RGYWlsKHRlc3QpIHtcclxuICAgICAgICB0aGlzLmxvZyhcIm9uVGVzdEZhaWw6IFwiICwgSlNPTi5zdHJpbmdpZnkodGVzdCkpO1xyXG4gICAgICAgIHRoaXMubWV0cmljcy5mYWlsZWQrKztcclxuICAgIH1cclxuXHJcbiAgICBvbkhvb2tFbmQoaG9vaykge1xyXG4gICAgICAgIGlmIChob29rLmVycm9yKSB7XHJcbiAgICAgICAgICAgIHRoaXMubWV0cmljcy5mYWlsZWQrKztcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBvblRlc3RFbmQodGhlVGVzdCkge1xyXG4gICAgICAgIHRoaXMubG9nKFwib25UZXN0RW5kOiBcIiAsIEpTT04uc3RyaW5naWZ5KHRoZVRlc3QpKTtcclxuICAgICAgICBsZXQgdGVzdCA9IHRoaXMuZ2V0VGVzdCh0aGVUZXN0LnVpZCkgO1xyXG4gICAgICAgIHRoaXMubW92ZUVycm9yc1RvRXZlbnRzKHRlc3QpIDtcclxuICAgIH1cclxuXHJcbiAgICBvblN1aXRlRW5kKHN1aXRlKSB7XHJcbiAgICAgICAgdGhpcy5sb2coXCJvblN1aXRlRW5kOiBcIiAsIEpTT04uc3RyaW5naWZ5KHN1aXRlKSk7XHJcbiAgICAgICAgdGhpcy5pbmRlbnRzLS07XHJcbiAgICB9XHJcblxyXG4gICAgaXNTY3JlZW5zaG90Q29tbWFuZChjb21tYW5kKSB7XHJcbiAgICAgICAgY29uc3QgaXNTY3JlZW5zaG90RW5kcG9pbnQgPSAvXFwvc2Vzc2lvblxcL1teL10qXFwvc2NyZWVuc2hvdC9cclxuICAgICAgICByZXR1cm4gaXNTY3JlZW5zaG90RW5kcG9pbnQudGVzdChjb21tYW5kLmVuZHBvaW50KVxyXG4gICAgfVxyXG5cclxuICAgIC8vdGhpcyBpcyBhIGhhY2sgdG8gZ2V0IGFyb3VuZCBsYWNrIG9mIG9uU2NyZWVuc2hvdCBldmVudFxyXG4gICAgb25BZnRlckNvbW1hbmQoY29tbWFuZCkge1xyXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMudXNlT25BZnRlckNvbW1hbmRGb3JTY3JlZW5zaG90KSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmlzU2NyZWVuc2hvdENvbW1hbmQoY29tbWFuZCkgJiYgY29tbWFuZC5yZXN1bHQudmFsdWUpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHRpbWVzdGFtcCA9IG1vbWVudCgpLmZvcm1hdCgnWVlZWU1NREQtSEhtbXNzLlNTUycpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZmlsZXBhdGggPSBwYXRoLmpvaW4odGhpcy5vcHRpb25zLm91dHB1dERpciwgJy9zY3JlZW5zaG90cy8nLCB0aGlzLmNpZCwgdGltZXN0YW1wLCB0aGlzLm9wdGlvbnMuZmlsZW5hbWUgKyAnLnBuZycpO1xyXG4gICAgICAgICAgICAgICAgZnMub3V0cHV0RmlsZVN5bmMoZmlsZXBhdGgsIEJ1ZmZlci5mcm9tKGNvbW1hbmQucmVzdWx0LnZhbHVlLCAnYmFzZTY0JykpO1xyXG5cclxuICAgICAgICAgICAgICAgIGxldCB0ZXN0ID0gdGhpcy5nZXRUZXN0KHRoaXMudGVzdFVpZCk7XHJcbiAgICAgICAgICAgICAgICB0ZXN0LmV2ZW50cy5wdXNoKHt0eXBlOiAnc2NyZWVuc2hvdCcsIHZhbHVlOiBmaWxlcGF0aH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuXHJcbiAgICBsb2cobWVzc2FnZSxvYmplY3QsZm9yY2UpIHtcclxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmRlYnVnIHx8IGZvcmNlKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKG1lc3NhZ2UgKyBvYmplY3QpIDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBnZXRTdWl0ZSh1aWQpIHtcclxuICAgICAgICBmb3IgKGxldCBpID0gMCA7IGkgPCB0aGlzLnN1aXRlcy5sZW5ndGggOyBpKyspIHtcclxuICAgICAgICAgICAgaWYgKHVpZCA9PT0gdGhpcy5zdWl0ZXNbaV0udWlkKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zdWl0ZXNbaV0gO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG5cclxuICAgIGdldFRlc3QodWlkKSB7XHJcbiAgICAgICAgbGV0IHN1aXRlID0gdGhpcy5nZXRTdWl0ZSh0aGlzLnN1aXRlVWlkKTtcclxuICAgICAgICBmb3IgKGxldCBpID0gMCA7IGkgPCBzdWl0ZS50ZXN0cy5sZW5ndGggOyBpKyspIHtcclxuICAgICAgICAgICAgaWYgKHVpZCA9PT0gc3VpdGUudGVzdHNbaV0udWlkKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gc3VpdGUudGVzdHNbaV0gO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG5cclxuICAgIC8vdGhpcyBpcyBhIGhhY2suICB3ZSBoYXZlIHRvIG1vdmUgYWxsIHRoZSB0aGluZ3MgaW4gdGVzdC5lcnJvcnMgYmVmb3JlIHRoZXkgZ2V0IGJsb3duIGF3YXlcclxuXHJcbiAgICBtb3ZlRXJyb3JzVG9FdmVudHModGVzdCkge1xyXG4gICAgICAgIGlmICh0ZXN0LmVycm9ycykge1xyXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gdGVzdC5lcnJvckluZGV4OyBpIDwgdGVzdC5lcnJvcnMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIHRlc3QuZXZlbnRzLnB1c2godGVzdC5lcnJvcnNbaV0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRlc3QuZXJyb3JJbmRleCA9IHRlc3QuZXJyb3JzLmxlbmd0aDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgc2F2ZVNjcmVlbnNob3QoZmlsZXBhdGgpIHtcclxuICAgICAgICBsZXQgdGVzdCA9IHRoaXMuZ2V0VGVzdCh0aGlzLnRlc3RVaWQpIDtcclxuICAgICAgICB0aGlzLm1vdmVFcnJvcnNUb0V2ZW50cyh0ZXN0KSA7XHJcbiAgICAgICAgdGVzdC5ldmVudHMucHVzaCh7dHlwZTogJ3NjcmVlbnNob3QnLCB2YWx1ZTogZmlsZXBhdGh9KSA7XHJcbiAgICB9XHJcblxyXG4gICAgc2F2ZU1lc3NhZ2UobWVzc2FnZSkge1xyXG4gICAgICAgIGNvbnN0IHRlc3QgPSB0aGlzLmdldFRlc3QodGhpcy50ZXN0VWlkKTtcclxuICAgICAgICB0aGlzLm1vdmVFcnJvcnNUb0V2ZW50cyh0ZXN0KSA7XHJcbiAgICAgICAgdGVzdC5ldmVudHMucHVzaCh7dHlwZTogJ2xvZycsIHZhbHVlOiBtZXNzYWdlfSkgO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBnZXRPcmRlcmVkU3VpdGVzKCkge1xyXG4gICAgICAgIGlmICh0aGlzLm9yZGVyZWRTdWl0ZXMpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMub3JkZXJlZFN1aXRlcztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMub3JkZXJlZFN1aXRlcyA9IFtdO1xyXG5cclxuICAgICAgICBmb3IgKGNvbnN0IHVpZCBvZiB0aGlzLnN1aXRlVWlkcykge1xyXG4gICAgICAgICAgICBmb3IgKGNvbnN0IHN1aXRlIG9mIHRoaXMuc3VpdGVzKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoc3VpdGUudWlkICE9PSB1aWQpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICB0aGlzLm9yZGVyZWRTdWl0ZXMucHVzaChzdWl0ZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB0aGlzLm9yZGVyZWRTdWl0ZXM7XHJcbiAgICB9XHJcblxyXG4vLyBjb252ZXJ0IHRvIGEgc3R5bGUgY2xhc3NcclxuICAgIGluZGVudCh1aWQpIHtcclxuICAgICAgICBjb25zdCBpbmRlbnRzID0gdGhpcy5zdWl0ZUluZGVudHNbdWlkXTtcclxuICAgICAgICByZXR1cm4gaW5kZW50cyA9PT0gMCA/ICcnIDogQXJyYXkoaW5kZW50cykuam9pbignICAgICcpO1xyXG4gICAgfVxyXG5cclxuICAgIG9uUnVubmVyRW5kKHJ1bm5lcikge1xyXG4gICAgICAgIGxldCBzZWxmID0gdGhpcyA7XHJcbiAgICAgICAgdGhpcy5sb2coXCJvblJ1bm5lckVuZDogXCIgLCBKU09OLnN0cmluZ2lmeShydW5uZXIpKTtcclxuICAgICAgICBzZWxmLm9wZW5JblByb2dyZXNzID0gdHJ1ZTtcclxuICAgICAgICBzZWxmLm1ldHJpY3Muc3RhcnQgPSBydW5uZXIuc3RhcnQgO1xyXG4gICAgICAgIHNlbGYubWV0cmljcy5lbmQgPSBydW5uZXIuZW5kIDtcclxuICAgICAgICBzZWxmLm1ldHJpY3MuZHVyYXRpb24gPSBydW5uZXIuX2R1cmF0aW9uO1xyXG5cclxuICAgICAgICBjb25zdCByZXBvcnRPcHRpb25zID0ge1xyXG4gICAgICAgICAgICBkYXRhIDoge1xyXG4gICAgICAgICAgICAgICAgaW5mbzogcnVubmVyLFxyXG4gICAgICAgICAgICAgICAgbWV0cmljczogc2VsZi5tZXRyaWNzLFxyXG4gICAgICAgICAgICAgICAgc3VpdGVzOiBzZWxmLmdldE9yZGVyZWRTdWl0ZXMoKSxcclxuICAgICAgICAgICAgICAgIHRpdGxlOiBzZWxmLm9wdGlvbnMucmVwb3J0VGl0bGUsXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIHNob3dJbkJyb3dzZXIgOiBzZWxmLm9wdGlvbnMuc2hvd0luQnJvd3NlcixcclxuICAgICAgICAgICAgb3V0cHV0RGlyIDogc2VsZi5vcHRpb25zLm91dHB1dERpcixcclxuICAgICAgICAgICAgcmVwb3J0RmlsZSA6IHBhdGguam9pbihwcm9jZXNzLmN3ZCgpLCBzZWxmLm9wdGlvbnMub3V0cHV0RGlyLCBzZWxmLnN1aXRlVWlkICwgc2VsZi5jaWQsIHNlbGYub3B0aW9ucy5maWxlbmFtZSlcclxuICAgICAgICB9O1xyXG4gICAgICAgIEh0bWxHZW5lcmF0b3IuaHRtbE91dHB1dChyZXBvcnRPcHRpb25zLCgpID0+IHtcclxuICAgICAgICAgICAgc2VsZi5vcGVuSW5Qcm9ncmVzcyA9IGZhbHNlICA7XHJcbiAgICAgICAgfSlcclxuICAgIH1cclxuXHJcbn1cclxuXHJcbmV4cG9ydCBkZWZhdWx0IEh0bWxSZXBvcnRlcjtcclxuIl19