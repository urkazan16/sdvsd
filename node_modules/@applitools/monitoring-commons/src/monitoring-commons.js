'use strict'

function makeTiming({parentPerformance = undefined} = {}) {
  const performance = parentPerformance || {}

  /**
   *
   * @template T
   * @param {string} name
   * @param {()=>Promise<T>} f
   * @returns {Promise<T>}
   */
  function timeItAsync(name, f) {
    const start = Date.now()

    return f().then(
      v => ((performance[name] = (performance[name] || 0) + Date.now() - start), v),
      v => ((performance[name] = (performance[name] || 0) + Date.now() - start), Promise.reject(v)),
    )
  }

  /**
   *
   * @template T
   * @param {string} name
   * @param {()=>T} f
   * @returns
   */
  function timeIt(name, f) {
    const start = Date.now()
    try {
      const ret = f()

      performance[name] = (performance[name] || 0) + Date.now() - start

      return ret
    } catch (err) {
      performance[name] = (performance[name] || 0) + Date.now() - start
      throw err
    }
  }

  return {
    timeItAsync,
    timeIt,
    performance,
  }
}

module.exports = {
  makeTiming,
}
